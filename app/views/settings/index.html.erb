<div class="container" style="max-width: 800px; margin: 40px auto;">
  <div class="header">
    <h1>‚öôÔ∏è Configura√ß√µes</h1>
    <%= link_to '‚Üê Voltar ao Dashboard', dashboard_path, class: 'btn btn-secondary' %>
  </div>

  <% if notice %>
    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 20px 0;">
      <%= notice %>
    </div>
  <% end %>

  <% if alert %>
    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0;">
      <%= alert %>
    </div>
  <% end %>

  <!-- Se√ß√£o de Exporta√ß√£o -->
  <div class="settings-section" style="background: white; border-radius: 12px; padding: 30px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0; color: #333;">üì• Exportar Dados</h2>
    <p style="color: #666; margin-bottom: 20px;">
      Fa√ßa o download de todos os seus dados em formato Excel. O arquivo incluir√°:
    </p>
    <ul style="color: #666; margin-bottom: 20px;">
      <li>Todos os seus h√°bitos (nome, descri√ß√£o, dias da semana, frequ√™ncia, status ativo)</li>
      <li>Todos os registros de progresso com datas e observa√ß√µes</li>
      <li>Suas tags personalizadas com cores</li>
      <li>Rela√ß√µes entre h√°bitos e tags</li>
    </ul>
    <%= link_to 'üìä Baixar Backup (Excel)', settings_export_path,
        class: 'btn btn-primary',
        style: 'display: inline-block; padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 8px; font-weight: bold;',
        data: { turbo: false } %>
  </div>

  <!-- Se√ß√£o de Importa√ß√£o -->
  <div class="settings-section" style="background: white; border-radius: 12px; padding: 30px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0; color: #333;">üì§ Importar Dados</h2>

    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
      <strong style="color: #856404;">‚ö†Ô∏è ATEN√á√ÉO:</strong>
      <p style="color: #856404; margin: 10px 0 0 0;">
        A importa√ß√£o ir√° <strong>SUBSTITUIR</strong> todos os seus dados atuais.
        Certifique-se de fazer um backup antes de importar!
      </p>
    </div>

    <p style="color: #666; margin-bottom: 20px;">
      Restaure seus dados a partir de um arquivo Excel exportado anteriormente:
    </p>

    <%= form_with url: settings_import_path, multipart: true, local: true do |f| %>
      <div style="margin-bottom: 20px;">
        <%= f.file_field :file,
            accept: '.xlsx',
            style: 'display: block; margin-bottom: 10px; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; width: 100%;' %>
        <small style="color: #999;">Apenas arquivos .xlsx s√£o suportados</small>
      </div>

      <%= f.submit 'üì• Importar Backup',
          class: 'btn btn-danger',
          style: 'padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;',
          data: { confirm: 'Tem certeza? Isso ir√° SUBSTITUIR todos os seus dados atuais!' } %>
    <% end %>
  </div>

  <!-- Informa√ß√µes Adicionais -->
  <div class="settings-section" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin: 20px 0;">
    <h3 style="margin-top: 0; color: #333; font-size: 18px;">‚ÑπÔ∏è Sobre os Backups</h3>
    <ul style="color: #666; line-height: 1.8; margin: 0;">
      <li>Os arquivos exportados s√£o compat√≠veis com Excel, Google Sheets e LibreOffice</li>
      <li>Voc√™ pode editar os dados no Excel antes de reimportar (cuidado com o formato!)</li>
      <li>Recomendamos fazer backups regulares dos seus dados</li>
      <li>Os IDs originais ser√£o preservados para manter a integridade dos dados</li>
    </ul>
  </div>

  <!-- Se√ß√£o de Review de Registros -->
  <div class="settings-section" style="background: white; border-radius: 12px; padding: 30px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <h2 style="margin-top: 0; color: #333;">üìÖ Review de Registros</h2>
    <p style="color: #666; margin-bottom: 20px;">
      Visualize todos os registros de h√°bitos executados em um per√≠odo espec√≠fico.
    </p>

    <!-- Filtros de Data -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
      <form id="review-filter-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
          <div>
            <label style="display: block; color: #333; font-weight: bold; margin-bottom: 5px;">
              üìÜ Data Inicial
            </label>
            <input type="date" id="start-date" name="start_date"
                   value="<%= (Date.today - 7.days).strftime('%Y-%m-%d') %>"
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
          </div>
          <div>
            <label style="display: block; color: #333; font-weight: bold; margin-bottom: 5px;">
              üìÜ Data Final
            </label>
            <input type="date" id="end-date" name="end_date"
                   value="<%= Date.today.strftime('%Y-%m-%d') %>"
                   style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
          </div>
          <div>
            <button type="submit"
                    style="padding: 10px 24px; background: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
              üîç Filtrar
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- √Årea de Resultados -->
    <div id="review-results">
      <div style="text-align: center; color: #999; padding: 40px;">
        Selecione um per√≠odo e clique em "Filtrar" para ver os registros
      </div>
    </div>
  </div>
</div>

<style>
  .settings-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
  }

  .btn {
    transition: all 0.3s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .registro-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #28a745;
    transition: all 0.3s ease;
  }

  .registro-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
  }

  .registro-item.nao-concluido {
    border-left-color: #dc3545;
    opacity: 0.7;
  }

  .registro-date {
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
    font-size: 16px;
  }

  .habito-nome {
    color: #007bff;
    font-weight: bold;
    margin-right: 10px;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }

  .status-concluido {
    background: #d4edda;
    color: #155724;
  }

  .status-nao-concluido {
    background: #f8d7da;
    color: #721c24;
  }

  .observacao {
    color: #666;
    font-style: italic;
    margin-top: 8px;
    padding-left: 10px;
    border-left: 2px solid #ddd;
  }

  .summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
  }

  .stat-card.success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
  }

  .stat-card.danger {
    background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
  }

  .stat-number {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .stat-label {
    font-size: 14px;
    opacity: 0.9;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('review-filter-form');
  const resultsDiv = document.getElementById('review-results');

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!startDate || !endDate) {
      alert('Por favor, selecione as datas inicial e final');
      return;
    }

    // Mostrar loading
    resultsDiv.innerHTML = `
      <div style="text-align: center; color: #666; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>
        <div>Carregando registros...</div>
      </div>
    `;

    // Fazer requisi√ß√£o AJAX
    fetch(`/settings/review?start_date=${startDate}&end_date=${endDate}`, {
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.registros.length === 0) {
        resultsDiv.innerHTML = `
          <div style="text-align: center; color: #999; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
            <div>Nenhum registro encontrado neste per√≠odo</div>
          </div>
        `;
        return;
      }

      // Calcular estat√≠sticas
      const totalRegistros = data.registros.length;
      const concluidos = data.registros.filter(r => r.concluido).length;
      const naoConcluidos = totalRegistros - concluidos;
      const taxaSucesso = ((concluidos / totalRegistros) * 100).toFixed(1);

      let html = `
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-number">${totalRegistros}</div>
            <div class="stat-label">Total de Registros</div>
          </div>
          <div class="stat-card success">
            <div class="stat-number">${concluidos}</div>
            <div class="stat-label">Conclu√≠dos (${taxaSucesso}%)</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-number">${naoConcluidos}</div>
            <div class="stat-label">N√£o Conclu√≠dos</div>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h3 style="color: #333; margin-bottom: 15px;">üìù Detalhes dos Registros</h3>
      `;

      // Agrupar por data
      const registrosPorData = {};
      data.registros.forEach(registro => {
        if (!registrosPorData[registro.data]) {
          registrosPorData[registro.data] = [];
        }
        registrosPorData[registro.data].push(registro);
      });

      // Ordenar datas (mais recente primeiro)
      const datasOrdenadas = Object.keys(registrosPorData).sort().reverse();

      datasOrdenadas.forEach(data => {
        html += `<div class="registro-date">${data}</div>`;

        registrosPorData[data].forEach(registro => {
          const concluido = registro.concluido;
          const itemClass = concluido ? 'registro-item' : 'registro-item nao-concluido';
          const statusClass = concluido ? 'status-badge status-concluido' : 'status-badge status-nao-concluido';
          const statusText = concluido ? '‚úÖ Conclu√≠do' : '‚ùå N√£o Conclu√≠do';

          html += `
            <div class="${itemClass}">
              <div>
                <span class="habito-nome">${registro.habito_nome}</span>
                <span class="${statusClass}">${statusText}</span>
              </div>
              ${registro.observacao ? `<div class="observacao">"${registro.observacao}"</div>` : ''}
            </div>
          `;
        });
      });

      html += '</div>';
      resultsDiv.innerHTML = html;
    })
    .catch(error => {
      console.error('Erro:', error);
      resultsDiv.innerHTML = `
        <div style="text-align: center; color: #dc3545; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
          <div>Erro ao carregar registros. Tente novamente.</div>
        </div>
      `;
    });
  });
});
</script>
