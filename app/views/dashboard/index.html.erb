<!-- app/views/dashboard/index.html.erb -->
<div class="container">
  <div class="header">
    <h1>Meus HÃ¡bitos</h1>
    <div class="header-actions">
      <button id="btn-ver-hoje" class="btn btn-ver-hoje">Ver Hoje</button>
      <%= link_to 'Ver Grade', dashboard_grid_path(mes: @mes, ano: @ano), class: 'btn btn-secondary' %>
      <%= link_to 'Novo HÃ¡bito', new_habito_path, class: 'btn btn-primary' %>
    </div>
  </div>

  <!-- Daily Summary Stats -->
  <%
    # Calculate today's stats
    hoje = Date.today
    habitos_hoje = @habitos.select { |h| h.fazer_hoje?(hoje) }
    habitos_feitos_hoje = habitos_hoje.select { |h| h.feito_no_dia?(hoje) }
    percentual_hoje = habitos_hoje.any? ? ((habitos_feitos_hoje.count.to_f / habitos_hoje.count) * 100).round : 0

    # Calculate month stats
    inicio_mes = Date.new(@ano, @mes, 1)
    fim_mes = inicio_mes.end_of_month
    dias_mes = (inicio_mes..fim_mes).to_a

    total_dias_agendados = 0
    total_dias_completos = 0

    dias_mes.each do |dia|
      next if dia > hoje
      habitos_dia = @habitos.select { |h| h.fazer_hoje?(dia) }
      next if habitos_dia.empty?

      total_dias_agendados += 1
      habitos_feitos_dia = habitos_dia.select { |h| h.feito_no_dia?(dia) }
      total_dias_completos += 1 if habitos_feitos_dia.count == habitos_dia.count
    end

    percentual_mes = total_dias_agendados > 0 ? ((total_dias_completos.to_f / total_dias_agendados) * 100).round : 0
  %>

  <div class="daily-summary">
    <div class="summary-card">
      <div class="summary-icon">ğŸ“…</div>
      <div class="summary-content">
        <div class="summary-label">Hoje</div>
        <div class="summary-value"><%= habitos_feitos_hoje.count %>/<%= habitos_hoje.count %></div>
        <div class="summary-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: <%= percentual_hoje %>%"></div>
          </div>
          <span class="progress-text"><%= percentual_hoje %>%</span>
        </div>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-icon">ğŸ“Š</div>
      <div class="summary-content">
        <div class="summary-label">Este MÃªs</div>
        <div class="summary-value"><%= total_dias_completos %>/<%= total_dias_agendados %> dias</div>
        <div class="summary-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: <%= percentual_mes %>%"></div>
          </div>
          <span class="progress-text"><%= percentual_mes %>%</span>
        </div>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-icon">ğŸ¯</div>
      <div class="summary-content">
        <div class="summary-label">HÃ¡bitos Ativos</div>
        <div class="summary-value"><%= @habitos.count %></div>
        <div class="summary-subtitle"><%= habitos_hoje.count %> agendados hoje</div>
      </div>
    </div>

    <div class="summary-card">
      <div class="summary-icon">ğŸ”¥</div>
      <div class="summary-content">
        <div class="summary-label">SequÃªncia</div>
        <%
          # Calculate longest current streak
          max_streak = 0
          @habitos.each do |habito|
            streak = 0
            data = hoje
            while habito.fazer_hoje?(data) && habito.feito_no_dia?(data)
              streak += 1
              data -= 1.day
              break if streak > 365 # Safety limit
            end
            max_streak = streak if streak > max_streak
          end
        %>
        <div class="summary-value"><%= max_streak %> dias</div>
        <div class="summary-subtitle">maior sequÃªncia ativa</div>
      </div>
    </div>
  </div>

  <!-- NavegaÃ§Ã£o de Meses -->
  <div class="mes-navegacao">
    <%= link_to dashboard_path(mes: @mes == 1 ? 12 : @mes - 1,
                                ano: @mes == 1 ? @ano - 1 : @ano),
                class: 'btn-nav' do %>
      â† MÃªs Anterior
    <% end %>

    <h2 class="mes-atual">
      <%= I18n.t("date.month_names")[@mes] %> <%= @ano %>
    </h2>

    <%= link_to dashboard_path(mes: @mes == 12 ? 1 : @mes + 1,
                                ano: @mes == 12 ? @ano + 1 : @ano),
                class: 'btn-nav' do %>
      PrÃ³ximo MÃªs â†’
    <% end %>

    <%= link_to 'Voltar para Hoje', dashboard_path, class: 'btn btn-hoje' %>
  </div>

  <!-- Filtro de Tags -->
  <% if current_user.tags.any? %>
    <div class="tags-filter">
      <button class="tag-filter active" data-tag-id="all">Todos</button>
      <% current_user.tags.each do |tag| %>
        <button class="tag-filter" data-tag-id="<%= tag.id %>" style="background-color: <%= tag.cor %>">
          <%= tag.nome %>
        </button>
      <% end %>
    </div>
  <% end %>

  <% if @habitos.empty? %>
    <div class="empty-state">
      <p>VocÃª ainda nÃ£o tem hÃ¡bitos cadastrados.</p>
      <%= link_to 'Criar primeiro hÃ¡bito', new_habito_path, class: 'btn btn-primary' %>
    </div>
  <% else %>
    <% @habitos.each do |habito| %>
      <div class="habito-card" data-tag-ids="<%= habito.tag_ids.join(',') %>">
        <div class="habito-header">
          <div class="habito-title-section">
            <h2><%= habito.nome %></h2>
            <% if habito.tags.any? %>
              <div class="habito-tags">
                <% habito.tags.each do |tag| %>
                  <span class="tag-badge" style="background-color: <%= tag.cor %>"><%= tag.nome %></span>
                <% end %>
              </div>
            <% end %>
            <% if habito.descricao.present? %>
              <p class="habito-descricao"><%= habito.descricao %></p>
            <% end %>
          </div>

          <div class="habito-progresso-side">
            <% progresso_mes = calcular_progresso_mes(habito, @mes, @ano) %>
            <div class="progresso-percentual">
              <%= progresso_mes[:percentual] %>%
            </div>
            <div class="progresso-detalhes">
              <strong><%= progresso_mes[:feitos] %></strong> / <%= progresso_mes[:agendados] %> dias
            </div>
            <%= link_to 'ğŸ“Š EstatÃ­sticas', estatisticas_habito_path(habito), class: 'btn-link-editar', style: 'margin-right: 0.5rem;' %>
            <%= link_to 'Editar', edit_habito_path(habito), class: 'btn-link-editar' %>
          </div>
        </div>

        <!-- CALENDÃRIO DO HÃBITO -->
        <%= render partial: 'habitos/calendario_mensal',
                   locals: { habito: habito, mes: @mes, ano: @ano } %>
      </div>
    <% end %>
  <% end %>
</div>