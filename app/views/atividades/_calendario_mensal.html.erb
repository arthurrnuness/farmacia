<%
  mes_atual = mes
  ano_atual = ano
  primeiro_dia_mes = Date.new(ano_atual, mes_atual, 1)
  ultimo_dia_mes = primeiro_dia_mes.end_of_month
  hoje = Date.today
  
  # Vista compacta: √∫ltimas 2 semanas
  primeiro_dia_compacto = hoje - 13.days
  ultimo_dia_compacto = hoje
  
  # ID √∫nico para cada calend√°rio
  calendario_id = "calendario_#{atividade.id}"
%>

<div class="calendario-atividade" id="<%= calendario_id %>">
  <!-- Cabe√ßalho com bot√£o expandir -->
  <div class="calendario-header">
    <h4 class="calendario-titulo">
      <span class="calendario-periodo">
        <span class="periodo-compacto">√öltimas 2 semanas</span>
        <span class="periodo-expandido" style="display: none;">
          <%= I18n.t("date.month_names")[mes_atual] %> <%= ano_atual %>
        </span>
      </span>
    </h4>
    
    <button class="btn-expandir" onclick="toggleCalendario('<%= calendario_id %>')">
      <span class="icone-expandir">‚ñº</span>
      <span class="icone-recolher" style="display: none;">‚ñ≤</span>
    </button>
  </div>
  
  <!-- Vista Compacta (padr√£o) -->
  <div class="calendario-compacto">
    <div class="calendario-grid-compacto">
      <% (primeiro_dia_compacto..ultimo_dia_compacto).each do |dia| %>
        <% next unless atividade.fazer_hoje?(dia) %>
        
        <%
          registro = atividade.registros.find_by(data: dia)
          
          if registro.nil?
            cor_classe = 'neutro'
          elsif dia == hoje
            cor_classe = 'hoje'
          elsif dia > hoje
            cor_classe = 'futuro'
          elsif registro.concluido?
            cor_classe = 'feito'
          else
            cor_classe = 'nao-feito'
          end
        %>
        
        <div class="dia-compacto-wrapper">
          <%= link_to registro ? edit_registro_path(registro) : new_registro_path(atividade_id: atividade.id, data: dia), 
                      class: "dia-compacto #{cor_classe}", 
                      title: "#{dia.strftime('%d/%m/%Y - %A')}" do %>
            <div class="dia-numero-compacto"><%= dia.day %></div>
            <div class="dia-semana-compacto"><%= dia.strftime('%a')[0..2] %></div>
            <% if registro&.observacao.present? %>
              <span class="tem-nota-compacto">üìù</span>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- Vista Expandida (inicialmente oculta) -->
  <div class="calendario-expandido" style="display: none;">
    <div class="calendario-grid-pequeno">
      <!-- Cabe√ßalho dias da semana -->
      <% ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].each do |dia| %>
        <div class="dia-header-pequeno"><%= dia %></div>
      <% end %>
      
      <!-- C√©lulas vazias antes do primeiro dia -->
      <% primeiro_dia_mes.wday.times do %>
        <div class="dia-vazio-pequeno"></div>
      <% end %>
      
      <!-- Dias do m√™s -->
      <% (primeiro_dia_mes..ultimo_dia_mes).each do |dia| %>
        <%
          registro = atividade.registros.find_by(data: dia)
          
          if registro.nil?
            cor_classe = 'neutro'
          elsif dia == hoje
            cor_classe = 'hoje'
          elsif dia > hoje
            cor_classe = 'futuro'
          elsif registro.concluido?
            cor_classe = 'feito'
          else
            cor_classe = 'nao-feito'
          end
        %>
        
        <%= link_to registro ? edit_registro_path(registro) : new_registro_path(atividade_id: atividade.id, data: dia), 
                    class: "dia-pequeno #{cor_classe}", 
                    title: "#{dia.strftime('%d/%m/%Y')} - Clique para #{registro ? 'editar' : 'criar registro'}" do %>
          <%= dia.day %>
          <% if registro&.observacao.present? %>
            <span class="tem-nota">üìù</span>
          <% end %>
        <% end %>
      <% end %>
    </div>
    
    <!-- Estat√≠sticas do m√™s -->
    <div class="calendario-stats">
      <% progresso = calcular_progresso_mes(atividade, mes, ano) %>
      
      <div class="stat-item">
        <span class="stat-label">Taxa de conclus√£o:</span>
        <span class="stat-valor"><%= progresso[:percentual] %>%</span>
      </div>
      
      <div class="stat-item">
        <span class="stat-label">Dias feitos:</span>
        <span class="stat-valor"><%= progresso[:feitos] %> / <%= progresso[:agendados] %></span>
      </div>
    </div>
  </div>
  
  <!-- Legenda (sempre vis√≠vel) -->
  <div class="calendario-legenda">
    <span class="legenda-item"><span class="cor-box feito"></span> Feito</span>
    <span class="legenda-item"><span class="cor-box hoje"></span> Hoje</span>
    <span class="legenda-item"><span class="cor-box futuro"></span> Futuro</span>
    <span class="legenda-item"><span class="cor-box nao-feito"></span> N√£o feito</span>
    <span class="legenda-item"><span class="cor-box neutro"></span> Sem registro</span>
  </div>
</div>